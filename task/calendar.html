<!DOCTYPE html>
<html lang="zh-cn">
<head>
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta charset="UTF-8"/>
    <title>mdater</title>

    <!--css-->
    <link rel="stylesheet" href="css/zepto.mdater.css">
    <link rel="stylesheet" href="css/bootstrap.min.css">
    <link rel="stylesheet" href="css/app.css">
    <!--加载框-->
    <link rel="stylesheet" href="css/iosOverlay.css">
    <!--吐司-->
    <link rel="stylesheet" href="css/toast.css">

    <!--js-->
    <script src="js/util/zepto.js"></script>
    <script src="js/util/jquery-3.2.1.min.js"></script>
    <script>jQuery.noConflict()</script>
    <script src="js/util/bootstrap.min.js"></script>

    <!--加载框-->
    <script src="js/util/spin.min.js"></script>
    <script src="js/util/jquery.spin.js"></script>
    <script src="js/util/iosOverlay.js"></script>
    <!--吐司-->
    <script src="js/util/toast.js"></script>
    <!--custom-->
    <script src="js/common/app.js"></script>
    <script src="js/common/tool.js"></script>
    <script src="js/zepto.mdater.js"></script>


</head>
<body>
<div id="ca"></div>
<div id="container"></div>

<div id="tip">
    <div style="margin: 0 12px">
        <img src="img/no_appoint.png">
        <span id="s1">暂无预约</span>
    </div>
    <div style="margin: 0 12px">
        <img src="img/kuang_has_appoint.png">
        <span id="s2">有预约</span>
    </div>
    <div style="margin: 0 12px">
        <img src="img/kuang_appoint_full.png">
        <span id="s3">预约已满</span>
    </div>

</div>

<div class="bottom">
    <div>
        <p><strong id="date"></strong></p>
        <p style=" margin-left: 10px"><strong id="week"></strong></p>
    </div>
    <div style="flex: 1;display: flex;flex-direction: column;align-items: flex-end">
        <p><span id="appointTitle">当前客户</span> <strong id="num">0</strong> 位</p>
        <p class="text-center">
            <button id="look" type="button" class="btn" style="background-color: gainsboro">查看</button>
        </p>
    </div>
</div>

<script>
    var selectedDate;
    var str =location.search;
    var serviceUserID = str.getQuery("serviceUserID");
    var organizeID = str.getQuery("organizeID");
    var type = str.getQuery("type"); // 1维修 2美容  3洗车 4预约 5销售 6会员 7线上订单
    var isManager = str.getQuery("isManager"); // 是否是管理者，0否1是
    setUrl(str.getQuery("url"));

    // 测试====================================================
//    var serviceUserID = "000c92a9-0000-0000-0000-000072de5af0";
//    var organizeID = "000bd179-0000-0000-0000-0000167d779a";
//    var type = 3; // 1维修 2美容  3洗车 4预约 5销售 6会员 7线上订单
//    var isManager = 0; // 是否是管理者，0否1是
//    setUrl("http://dcaa.dj-soft.net/dcapi/App/jkgl/BusinessUnit/MerchantInterface/");


    if(type > 2 && type < 7){
        $("#s1").text("暂无客户");
        $("#s2").text("有未结算");
        $("#s3").text("全部结算");
        $("#look").text("查看详情");
        $("#appointTitle").text("已有客户");
    }
    if(type == 7){
        $("#appointTitle").text("当前预约");
    }
    // 预约模块，不显示tip
    if(type == 4){
        $("#tip").hide();
    }

    $(document).ready(function () {
//        selectedDate = getSelectedDate();
        console.log("初始化djy-->" + getSelectedDate());
        // 注册接受原生指定日期的方法
        try {
            window.dsBridge.register(SET_DATE_FROM_NATIVE, function(date){
                console.log("djy" + date);
                selectedDate = date;
                // 接口调用的太慢,故这边先显示日期，等接口数据返回再重新刷新
                $('#ca').setSelectedDate(selectedDate);
                work_calendar_list($('#ca').getYearMonth(date)[0], $('#ca').getYearMonth(date)[1]);
            });
        }catch (err){}


        $('#ca').mdater({
            minDate: new Date(2015, 2, 10),
            data: [],
            onSelected: function (date, week, appointNum) {
                $("#date").text(date);
                $("#week").text(week);
                $("#num").text(appointNum);
                if(appointNum == 0){
                    $("#look").css("background-color", "gainsboro");
                }else {
                    $("#look").css("background-color", "#FFD100");
                }
                selectedDate =  date.replace(/\./g,"-");
                console.log("djy js回调-->" + selectedDate + week);

                saveSelectedDate(selectedDate);
                work_calendar_appoint_list(selectedDate);

                // 2018-12-26变更需求 维修美容模块
                if(type == 1 || type == 2){
                    var d = new Date(selectedDate.replace(/-/g,"/"));
                    var todaysDate = new Date();

                    if(isManager == 1){
                        if(d.setHours(0,0,0,0) <= todaysDate.setHours(0,0,0,0)){
                            $("#appointTitle").text("当前客户");
                        }else {
                            $("#appointTitle").text("当前预约");
                        }
                    }else {
                        if(d.setHours(0,0,0,0) < todaysDate.setHours(0,0,0,0)){
                            $("#appointTitle").text("当前客户");
                        }else {
                            $("#appointTitle").text("当前预约");
                        }
                    }
                }

                // 每次重绘panel后，IOS的li点击事件不走，要加这个方法
                $('.md_datearea li').click(function () {});
            },
            onChangeMonth:function (year, month) {
                work_calendar_list(year, month);
            }
        });

//        if(stringIsBlank(getSelectedDate())) {
//            saveSelectedDate(new Date().format("yyyy-MM-dd"));
//        }
//        selectedDate = getSelectedDate();
//        $('#ca').setSelectedDate(selectedDate);
//
//        $("#look").click(function () {
//            dsBridge.call(LOOK_APPOINT_FROM_JS, {date: selectedDate, type: type}, function (responseData) {
//            });
//        });

        $('#ca').initListeners();

        if(type == 7 || isManager == 1){
            // reload刷新时调用
            if(getSelectedDate()){
                selectedDate = getSelectedDate();
                $('#ca').setSelectedDate(selectedDate);
                work_calendar_list($('#ca').getYearMonth(selectedDate)[0], $('#ca').getYearMonth(selectedDate)[1]);
            }else {
                // 线上订单和管理者日历，等待app传日期再调用
            }
        }else {
            if(stringIsBlank(getSelectedDate())) {
                saveSelectedDate(new Date().format("yyyy-MM-dd"));
            }
            selectedDate = getSelectedDate();
            $('#ca').setSelectedDate(selectedDate);
            work_calendar_list($('#ca').getYearMonth(selectedDate)[0], $('#ca').getYearMonth(selectedDate)[1]);
        }

        $("#look").click(function () {
            dsBridge.call(LOOK_APPOINT_FROM_JS, {date: selectedDate, type: type}, function (responseData) {
            });
        });

        console.log("屏幕宽度" + document.body.clientWidth);
        //手指接触屏幕
        document.getElementById("container").addEventListener("touchstart", function (e) {
            startx = e.touches[0].pageX;
            starty = e.touches[0].pageY;
        }, false);
        //手指离开屏幕
        document.getElementById("container").addEventListener("touchend", function (e) {
            var endx, endy;
            endx = e.changedTouches[0].pageX;
            endy = e.changedTouches[0].pageY;
            var direction = getDirection(startx, starty, endx, endy);
            switch (direction) {
                case 3:
                    console.log("右滑")
                    $('#ca').direction("right");
                    break;
                case 4:
                    console.log("左滑")
                    $('#ca').direction("left");
                    break;
                default:
            }
        }, false);
    });

    var startx, starty;
    //获得角度
    function getAngle(angx, angy) {
        return Math.atan2(angy, angx) * 180 / Math.PI;
    };

    //根据起点终点返回方向 1向上 2向下 3向左 4向右 0未滑动
    function getDirection(startx, starty, endx, endy) {
        var angx = endx - startx;
        var angy = endy - starty;
        var result = 0;

        //如果滑动距离太短
        if (Math.abs(angx) < 2 && Math.abs(angy) < 2) {
            return result;
        }

        var angle = getAngle(angx, angy);
        if (angle >= -135 && angle <= -45) {
            result = 1;
        } else if (angle > 45 && angle < 135) {
            result = 2;
        } else if ((angle >= 135 && angle <= 180) || (angle >= -180 && angle < -135)) {
            result = 3;
        } else if (angle >= -45 && angle <= 45) {
            result = 4;
        }

        return result;
    }

    /**
     * 获取单月工作日历列表
     */
    var listAjax = null;
    function work_calendar_list(year, month) {
        if(listAjax != null){
            listAjax.abort();
        }
        var obj = {};
        obj.serviceUserID = serviceUserID;
        obj.organizeID = organizeID;
        obj.year = year;
        obj.month = month;
        obj.type = type;
        var url;
        // 1维修 2美容  3洗车 4预约 5销售 6会员 7线上订单
        if(type == 1 || type == 2){
            url = RepairManage + "work_calendar_list";
        }else if(type == 3){
            url = WashManage + "wash_calendar_list";
        }else if(type == 4){
            url = AppointManage + "appointment_calendar_list";
        }else if(type == 5){
            url = SaleManage + "sale_calendar_list";
        }else if(type == 6){
            url = MemberManage + "member_calendar_list";
        }else if(type == 7){
            url = OnlineOrderManage + "onlineOrder_calendar_list";
        }
        console.log("djy url =  " + url);
        console.log("djy req " + JSON.stringify(obj));
        listAjax = $.ajax({
            url:url,
            type:"POST",
            data: obj,
            timeout:2000*10,
            dataType:"json",

            success:function (data,textStatus,jqXHR) {
                console.log("djy res " + JSON.stringify(data));
                // 返回结果状态值,值为0或1.(0表示请求失败；1表示请求成功)
                if(data.status == 1){
                    $('#ca').changeData(data.dayList, selectedDate, year, month);
                }
            },
            error:function (xhr,textStatus) {
                console.log("djy 错误信息如下====================");
                console.log(xhr);
                console.log(textStatus);
            },
        });
    }
    /**
     * 查看单日预约工作日历列表
     */
    var countAjax = null;
    function work_calendar_appoint_list(day) {
        if(countAjax != null){
            countAjax.abort();
        }
        var obj = {};
        obj.serviceUserID = serviceUserID;
        obj.organizeID = organizeID;
        obj.day = day;

        var url;
        if(type == 1 || type == 2){
            obj.type = type;  // 1维修 2美容  3洗车 4预约 5销售 6会员
            url = RepairManage + "work_calendar_list_count";
        }else if(type == 3){
            url = WashManage + "wash_calendar_count";
        }else if(type == 4){
            url = AppointManage + "appointment_calendar_count";
        }else if(type == 5){
            url = SaleManage + "sale_calendar_count";
        } else if(type == 6){
            url = MemberManage + "member_calendar_count";
        } else if(type == 7){
            obj.plateNumber = "";
            obj.page = 1;
            obj.rows = 10000;
            url = OnlineOrderManage + "onlineOrder_appoint_list";
        }

        console.log("djy url =  " + url);
        console.log("djy req " + JSON.stringify(obj));

        countAjax = $.ajax({
            url:url,
            type:"POST",
            data: obj,
            timeout:1000*10,
            dataType:"json",

            success:function (data) {
                console.log("djy res " + JSON.stringify(data));
                // 返回结果状态值,值为0或1.(0表示请求失败；1表示请求成功)
                if(data.status == 1){
                    $("#num").text(data.totalCount);

                    if(data.totalCount == 0){
                        $("#look").css("background-color", "gainsboro");
                    }else {
                        $("#look").css("background-color", "#FFD100");
                    }
                }
            },
            error:function (xhr,textStatus) {
                console.log("错误信息如下====================");
                console.log(xhr);
                console.log(textStatus);
            },
        });
    }
</script>
</body>
</html>